<!DOCTYPE HTML>
<html>
  <head>
    <title>Mailto</title>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
    <script type="text/javascript">
      // Handle a click on a mailto: link
      chrome.extension.onRequest.addListener(function(mailtoLink, sender, sendResponse) {
        var mailtoAddresses = {
          fastmail: "http://ssl.fastmail.fm/action/compose/?to={to}&cc={cc}&bcc={bcc}&subject={subject}&body={body}",
          gmail: "https://mail.google.com/mail/?view=cm&tf=1&to={to}&cc={cc}&bcc={bcc}&su={subject}&body={body}",
          hotmail: "http://mail.live.com/?rru=compose?To={to}&CC={cc}&subject={subject}&body={body}",
          ymail: "http://compose.mail.yahoo.com/?To={to}&Cc={cc}&Bcc={bcc}&Subj={subject}&Body={body}",
          zoho: "https://zmail.zoho.com/mail/compose.do?extsrc=mailto&mode=compose&tp=zb&ct={to}"
        };

        var email = window.localStorage.mail || "gmail";
        var link = mailtoAddresses[email];
        var queryparts = {};
        var i;
        var params = ("to=" + mailtoLink).replace('?', '&').split('&');
        for (i = 0; i < params.length; i++) {
          var split = params[i].split('=');
          var what = split[0].toLowerCase();
          if (queryparts[what]) {
            if (split[1] && (what === "to" || what === "bcc" || what === "cc")) {
              split[1] = queryparts[what] + ", " + split[1];
            } else if (what === "body") {
              split[1] = queryparts[what] + "%0D%0A" + split[1];
            }
          }
          if (split[1]) {
            queryparts[what] = window.unescape(split[1]);
          }
        }

        var prepareValue = function(part, isAddress) {
          var result = part || "";
          if (isAddress) {
            result = result.replace(/(^|\,)[^\,]*<(.+?\@.+?\..+?)\>/g, "$1$2");
            if (email === "hotmail") {
              result = result.replace(/\,/g, ';');
            }
          }
          return window.escape(result);
        };

        // Let the content script call window.open so it'll stay in incognito or non-incognito
        sendResponse(
          link.replace("{to}", prepareValue(queryparts.to, true)).
            replace("{cc}", prepareValue(queryparts.cc, true)).
            replace("{bcc}", prepareValue(queryparts.bcc, true)).
            replace("{subject}", prepareValue(queryparts.subject)).
            replace("{body}", prepareValue(queryparts.body))
        );
      });

      // On launch, check if an email provider was set
      if (!window.localStorage.mail) {
        window.open(chrome.extension.getURL('options.html'), "_blank",
                    'scrollbars=0,location=0,resizable=0,width=450,height=200');
      }
      else if (window.localStorage.mail === "wlm") {
        window.localStorage.mail = "hotmail"; //TEMP since 23-6-11
      }
    </script>
  </head>
  <body>
  </body>
</html>