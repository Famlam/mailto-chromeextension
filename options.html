<!DOCTYPE HTML>
<html>
  <head>
    <title data-i18n="options"></title>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
    <style type="text/css">
      body {
        padding-left: 25px;
        font: 14px arial;
      }
      fieldset {
        border-radius: 4px;
        border: 1px solid #666666;
        background-color: #f8faff;
        max-width: 100%;
      }
      legend {
        padding: 0 5px;
      }
      label {
        padding-left: 5px;
        cursor: pointer;
      }
      h1 {
        margin: 12px 18px;
      }
      .saved {
        color: blue;
        opacity: 0;
        margin-left: 75px;
      }
      #paypal {
        float: right;
        display: none;
      }
      #inputCustom {
        width: 98%;
        max-width: 500px;
      }
      #explainCustom, #addCustom, #removeCustom {
        font-size:10px;
        margin:3px;
      }
      #custom, #customLabel, #customURL, #removeCustom {
        display: none;
      }
      #customLabel {
        font-style: italic;
        margin-right: 5px;
      }
      a {
        color: blue;
      }
    </style>
    <script type="text/javascript">
      if (typeof safari !== "undefined") {
        chrome = {
          i18n: {
            getMessage: function(messageID, args) {
              var i;
              if (typeof chrome.i18n.strings === "undefined") {
                var languages = [window.navigator.language.replace('-', '_')];
                if (window.navigator.language.length > 2) {
                  languages.push(window.navigator.language.substring(0, 2));
                }
                if (window.navigator.language !== "en") {
                  languages.push("en");
                }
                chrome.i18n.strings = {};

                // Get the translation required and prepare it for being used.
                var fetchAndParse = function(locale) {
                  var xhr = new XMLHttpRequest();
                  xhr.open("GET", safari.extension.baseURI + "_locales/" + locale + "/messages.json", false);
                  xhr.onreadystatechange = function() {
                    if (this.readyState === 4 && this.responseText) {
                      var parsed = JSON.parse(this.responseText);
                      var string;
                      for (string in parsed) {
                        if (!chrome.i18n.strings[string]) {
                          var result = parsed[string].message;
                          // Parse placeholders
                          var ph = parsed[string].placeholders;
                          if (ph) {
                            var phID;
                            for (phID in ph) {
                              var rgx = new RegExp("\\$" + phID + "\\$");
                              result = result.replace(rgx, ph[phID].content);
                            }
                          }
                          chrome.i18n.strings[string] = result;
                        }
                      }
                    }
                  };
                  try {
                    xhr.send();
                  } catch (ex) {}
                };
                for (i=0; i < languages.length; i++) {
                  fetchAndParse(languages[i]);
                }
              }

              if (typeof args === "string") {
                args = [args];
              } else if (!args) {
                args = [];
              }
              var edited = chrome.i18n.strings[messageID].replace(/\$\$/g, "@@@@"); // $$ shouldn't get escaped
              for (i=0; i<args.length; i++) {
                var rgx = new RegExp("(?!\\$\\$)\\$" + (i+1), "g");
                edited = edited.replace(rgx, args[i]);
              }
              return edited.replace(/\@\@\@\@/g, "$$");
            }
          }
        };

        // The background page doesn't have direct access to localStorage changes
        // Therefore users must restart Safari first.
        var handleSafariLocalStorageBug = function() {
          if (handleSafariLocalStorageBug.handled) {
            return;
          }
          var warning = window.document.createElement("p");
          warning.innerText = chrome.i18n.getMessage("restartBrowser");
          warning.setAttribute("style", "font-weight: bold; color: red");
          window.document.body.appendChild(warning);
          window.document.removeEventListener("change", handleSafariLocalStorageBug);
          handleSafariLocalStorageBug.handled = true;
        };
        handleSafariLocalStorageBug.handled = false;
        window.document.addEventListener("change", handleSafariLocalStorageBug);
      }
    </script>
  </head>
  <body>
    <form id="paypal" action="https://www.paypal.com/cgi-bin/webscr" method="post">
      <input type="hidden" name="cmd" value="_s-xclick">
      <input type="hidden" name="encrypted" value="-----BEGIN PKCS7-----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-----END PKCS7-----">
      <input type="image" src="data:image/gif;base64,R0lGODlhSgAVAPcmAP+sLf7iq/7gpf7ksf7en/+6Tf+vM7+LNv+xOu7bskBedhA+a/+0QN+aLo9/WHBuWxA+aoCQl0BfeXB+f2BhUc+TMn+Jg7+YU76zkZ+HVp6jmX+Nj97Qre+iKo6Xk56gke+yT/63R3+LiTBUdO7Tm1BdXs4HAkBfd+7ZrH+Khs+VON7MomB0fkBgeq6ojf7HbGBze765o87Bnp6hlf/s0M7Do/7Rhb62mjBKWxA7YjBUczBUcv64SmB2gp9+Qs7EqP/89jBTcY6Uif+lNEBedN+dNIBwSa6wov/NgtEQBY6Vjb+OO/7amP++Xf+3RlBpev7UjP/Ti6+QVb++r8+hUs6/mf/05P/CYNEOBc6+lN7Knf7epP+oLH+MjJ6fjVBrfmBmXf/05v/ryf61Rv/ZoCBJbv/it3BoTY6WkP/py//YnyBCX/+vOkBVYP+/Wf63S767qP7WjP65Tf/w2f/FZu/gwv/u0++kMVBsgmB1gP7hqmB4h//uzv7dnv/w2HCAhP7Qf66smf+mLf/boP6/WTBMYf7Jcv+uM//y2yBIba6unv/sz//itv+pNP+yP/7mt/+pJv/15//rzv7pvv/syP/dqv/46v/03//OhP/w0/+/Xv+xOAAzZswAAP+ZMwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAEAACYALAAAAABKABUAAAj/AE0IHGjCk8GDCBMqXMiwocOEBCMONLgoTKSLGC8CAZKxo8ePIEN+tJLGoMSJcyypXMmypcuXMGPKfGnH00lPfi7p3Mmzp8+fQIMKDYrIJkFPYjIpXcq0qdOnUKNKncrHaMFBlLJq3cqVUoSvEaZ0HUuWa52yaClFMeppktu3cONOgsOpbt09cvPqfXsEz96/k6DY9MRjy6PDiBMr9sBJw6MELTj9OBxjgwcOhznESKBhQ4LDnDdoSJBAEacWmH9Y/qy49WEbPAy+MTSgtu3buHtwqlE7EKcuA3SPWLCA9xdOEkYgH4CCuATkaOzOmMFp+AIUuLMP0ENIjsExIWwE/xhPvnx5HZzI3+Ak4gOnPwFWcMoTAP2HABDSyxAhI8CJ9CJwcoN8JwTgnhLmJRjACyGEYJAjDDDwQh8CVGjhhRVyooCFQnDixROcaJHhhpzsMKIAVbCgQBklCqAAJwJ0qEAKLHCSAoYYMuFGhAwYxAYCQDJARxwEFGmkkRhwMkGRJCQCAQlEcFJkFpzAkOSSV5IAQRAuuKAkAVsSYEGVFpSJwZFHAnIFkGwadIgBcMZpQAF01kmnA5w8cIEUhXDiQAEPcJIBCG1wcgGeGRSA6AV5glCCoFRwUkIBjD6gKBgg2EmnE3LKaZAgAIQq6qikUmAXJzkYEeodONSVgw8AmLCqQqyczNoqJ2twskQRdVEAwBl2wUrqsKJyMRgkyCar7LIVHODsActC0mwHyDZbLbTIHtBAB9pC0kC33h5AbbTkIsvWEJukq+667Lbr7rvwxitvuo1Y5UkTmuSr77789uvvvwAHLLAmVgnkCRKYJKzwwgw37PDDEEccccETqVHJxRhnrPHGHHfs8ccck0HxUZ6YIcnJKKNMAw0pt+zyyzDHDDMjJp1E8kM456wzQycFBAA7" name="submit" alt="PayPal - The safer, easier way to pay online.">
    </form>

    <h1 data-i18n="options"></h1>
    <fieldset>
      <legend data-i18n="emailservice"></legend>
      <input name="mail" type="radio" id="aol"/><label for="aol">AOL mail</label>
      <span class="saved" id="mail" data-i18n="saved"></span><br/>
      <input name="mail" type="radio" id="fastmail"/><label for="fastmail">Fastmail</label><br/>
      <input name="mail" type="radio" id="gmail"/><label for="gmail">Gmail</label><br/>
      <input name="mail" type="radio" id="hotmail"/><label for="hotmail">Hotmail / Windows Live Mail</label><br/>
      <input name="mail" type="radio" id="ymail"/><label for="ymail">Yahoo mail</label><br/>
      <input name="mail" type="radio" id="zoho"/><label for="zoho">Zoho mail</label><br/>
      <input name="mail" type="radio" id="custom"/><label for="custom" id="customLabel"></label><a href="#customURL" id="addCustom"></a><a href="#" id="removeCustom" data-i18n="remove"></a>
    </fieldset>

    <fieldset id="customURL">
      <legend data-i18n="customEmailService"></legend>
      <input type="text" id="inputCustom" spellcheck="false"/>
      <input type="button" id="submitCustom" value="i18n" data-i18n="add" disabled="disabled"/><br/>
      <p id="explainCustom" data-i18n="customExplanation"></p>
    </fieldset>

    <script>
      // Set the option if it was already set before
      var initializeCustom = function() {
        var custom = window.localStorage.getItem("custom");
        if (custom) {
          window.document.getElementById("custom").style.display = "inline-block";
          window.document.getElementById("customLabel").style.display = "inline";
          window.document.getElementById("customLabel").innerText = custom;
          window.document.getElementById("removeCustom").style.display = "inline";
          window.document.getElementById("addCustom").innerText = chrome.i18n.getMessage("change");
          window.document.getElementById("inputCustom").value = custom;
        } else {
          window.document.getElementById("custom").style.display = "none";
          window.document.getElementById("customLabel").style.display = "none";
          window.document.getElementById("removeCustom").style.display = "none";
          window.document.getElementById("addCustom").innerText = chrome.i18n.getMessage("customURL");
          window.document.getElementById("inputCustom").value = "";
        }
        window.document.getElementById("addCustom").style.display = "inline";
        window.document.getElementById("customURL").style.display = "none";
      };
      initializeCustom();
      if (window.localStorage.getItem("mail")) {
        window.document.getElementById(window.localStorage.getItem("mail")).checked = true;
        window.document.getElementById("paypal").style.display = "block";
      }

      // ------ SAVING WHAT EMAIL CLIENT TO USE ------
      var hideInterval = null, saveLabelFadeOut = function() {
        // Fade out. If there are no more labels to fade out -> delete interval
        var i, items = window.document.getElementsByClassName("saved"), fadingLabelsCount = 0;
        for (i=0; i<items.length; i++) {
          if (!items[i].style || !items[i].style.opacity || items[i].style.opacity < 0.05) {
            items[i].style.opacity = 0;
            if (!fadingLabelsCount && i === items.length - 1) {
              window.clearInterval(hideInterval);
              hideInterval = null;
            }
          } else {
            items[i].style.opacity = items[i].style.opacity - 0.03;
            fadingLabelsCount++;
          }
        }
      };
      var setSetting = function(e) {
        // Save and show the correct 'saved' message
        window.localStorage.setItem(e.target.name, e.target.id);
        window.document.getElementById(e.target.name).style.opacity = 1;
        if (!hideInterval) {
          hideInterval = window.setInterval(saveLabelFadeOut, 200);
        }
      };

      // Trigger when an input element changes
      var i, items = window.document.getElementsByTagName("input");
      for (i=0; i<items.length; i++) {
        if (items[i].type === "radio") {
          items[i].addEventListener("change", setSetting);
        }
      }

      // ------ CUSTOM URLS ------
      // Validate the custom URL
      var validateCustomURL = function() {
        if (/^https?\:\/\/([a-z0-9\-_\xE3-\xFF]+\.)+[a-z0-9]+\/.*\{to\}/.test(window.document.getElementById("inputCustom").value)) {
          window.document.getElementById("submitCustom").disabled = false;
        } else {
          window.document.getElementById("submitCustom").disabled = true;
        }
      };
      window.document.getElementById("inputCustom").addEventListener("input", validateCustomURL);

      // Save a custom URL
      var addCustomURL = function() {
        setSetting({target: {name: "mail", id: "custom"}});
        window.document.getElementById("custom").checked = true;
        window.localStorage.setItem("custom", window.document.getElementById("inputCustom").value);
        if (typeof safari !== "undefined") {
          handleSafariLocalStorageBug();
        }
        initializeCustom();
      };
      window.document.getElementById("inputCustom").addEventListener("keypress", function(e) {
        if (e.keyCode === 13 && !window.document.getElementById("submitCustom").disabled) {
          addCustomURL();
          e.preventDefault();
        }
      });
      window.document.getElementById("submitCustom").addEventListener("click", addCustomURL);

      // Add, change or remove a custom URL
      window.document.getElementById("addCustom").addEventListener("click", function() {
        window.document.getElementById("customURL").style.display = "block";
        this.style.display = "none";
        validateCustomURL();
        window.document.getElementById("inputCustom").focus();
      });
      window.document.getElementById("removeCustom").addEventListener("click", function() {
        window.localStorage.removeItem("custom");
        if (window.localStorage.getItem("mail") === "custom") {
          window.localStorage.removeItem("mail");
        }
        window.document.getElementById("mail").style.opacity = 1;
        if (!hideInterval) {
          hideInterval = window.setInterval(saveLabelFadeOut, 200);
        }
        if (typeof safari !== "undefined") {
          handleSafariLocalStorageBug();
        }
        initializeCustom();
      });

      // ------ FINISHING TOUCH ------
      // Translate a page into the users language
      items = window.document.querySelectorAll("[data-i18n]");
      for (i=0; i<items.length; i++) {
        var translation = chrome.i18n.getMessage(items[i].getAttribute("data-i18n"));
        if (items[i].value === "i18n") {
          items[i].value = translation;
        } else {
          items[i].innerText = translation;
        }
      }
    </script>
  </body>
</html>